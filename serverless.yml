service: dispose-me

frameworkVersion: '1'

custom:
  customDomain:
    domainName: 'www.disposeme.de'
    autoDomain: true
    endpointType: 'regional'
    stage: ${self:provider.stage}
    createRoute53Record: true
  buckerName: ${self:service}-emails
  webpack:
    webpackConfig: './webpack.config.js'
    includeModules: true
  dotenv:
    logging: false
    exclude:
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY

provider:
  name: aws
  runtime: nodejs12.x
  stage: ${opt:stage,'staging'}
  region: eu-west-1	
  timeout: 3
  memorySize: 512
  apiGateway:
    minimumCompressionSize: 1024
    apiKeySourceType: AUTHORIZER
  logs:
    restApi:
      level: ERROR
      accessLogging: false
      fullExecutionData: false
  apiKeys:
    - 'Postman'
    - 'Appium tests'
  usagePlan:
    quota:
      limit: 5000
      period: DAY
    throttle:
      burstLimit: 3
      rateLimit: 1
  iamRoleStatements:
    - Effect: 'Allow'
      Action:
        - 's3:ListBucket'
      Resource:
        Fn::Join:
          - ''
          - - 'arn:aws:s3:::'
            - Ref: EmailBucket
    - Effect: 'Allow'
      Action:
        - 's3:GetObject'
        - 's3:PutObject'
        - 's3:DeleteObject'
      Resource:
        Fn::Join:
          - ''
          - - 'arn:aws:s3:::'
            - Ref: EmailBucket
            - '/*'

functions:
  api:
    handler: src/api.handler
    environment:
      AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1'
      BUCKET_NAME: ${self:custom.buckerName}
    events:
      - http:
          path: /
          method: get
          cors: true
          private: true
          authorizer:
            name: authorizer
            resultTtlInSeconds: 0
            identitySource: '' # needed to get rid of default: method.request.header.Authorizer
            type: request
      - http:
          path: /{proxy+}
          method: get
          cors: true
          private: true
          authorizer:
            name: authorizer
            resultTtlInSeconds: 0
            identitySource: ''
            type: request
  processor:
    handler: src/email-processor.handler
    environment:
      BUCKET_NAME: ${self:custom.buckerName}
  authorizer:
    handler: src/authorizer.handler
    environment:
      AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1'

plugins:
  - serverless-domain-manager
  - serverless-dotenv-plugin
  - serverless-webpack
  - serverless-offline

resources:
  Resources:
    EmailBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.buckerName}
        LifecycleConfiguration:
          Rules:
          - Id: CleanUpRule
            Status: Enabled
            ExpirationInDays: '1'
    EmailBucketPermissions:
      Type: AWS::S3::BucketPolicy
      DependsOn: EmailBucket
      Properties:
        Bucket:
          Ref: EmailBucket
        PolicyDocument:
          Statement:
            - Principal: 
                Service: "ses.amazonaws.com"
              Action:
                - s3:PutObject
              Effect: Allow
              Sid: "AllowSESPuts"
              Resource:
                Fn::Join: ['', ['arn:aws:s3:::', Ref: EmailBucket, '/*'] ]
              Condition:
                StringEquals:
                  "aws:Referer": { Ref: AWS::AccountId }
    SESPermission:
      Type: AWS::Lambda::Permission
      DependsOn:
        - ProcessorLambdaFunction
      Properties:
        FunctionName: ${self:service}-${self:provider.stage}-processor
        Action: lambda:InvokeFunction
        Principal: ses.amazonaws.com
        SourceAccount:
          Ref: AWS::AccountId
